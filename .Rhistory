knitr::opts_chunk$set(echo = TRUE)
library(bsseq)
library(data.table)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(scales)
library(SummarizedExperiment)
setwd("/home/projects/cu_10031/data/raw/DNBC_methylation_2023/2025_analysis/")
child_pheno<- read.table("child_pheno_120.txt", stringsAsFactors = FALSE, sep="\t", h=T)
# Create sample_id and file_name columns
child_pheno$sample_id <- as.character(child_pheno$MASTER_BARCODE)
child_pheno$file_name <- paste0(child_pheno$MASTER_BARCODE, "_pe.CpG_report.txt")
# Add treatment column for methylKit: 1 = CASE, 0 = CONTROL
child_pheno$treatment <- ifelse(child_pheno$CASECONTROL == "CASE", 1, 0)
# Reorder columns
sample_info <- child_pheno
# Save as CSV
write.csv(sample_info, "sample_info.csv", row.names = FALSE)
#meta data
biot1dm <- readRDS("biot1dm.Rds")
# merge two metadata files by LBGRAVNR
covars <- left_join(sample_info,biot1dm, by = c("LBGRAVNR" = "LBGRAVNR"))
View(covars)
# Function to load a single Bismark CpG_report file
read_bismark <- function(file, sample_name) {
df <- fread(file, header = FALSE)
colnames(df) <- c("chr", "pos", "strand", "methylated", "unmethylated")
df$coverage <- df$methylated + df$unmethylated
df$M <- df$methylated
df$Cov <- df$coverage
df$chr <- as.character(df$chr)
df$pos <- as.integer(df$pos)
df$sample <- sample_name
return(df[, .(chr, pos, M, Cov, sample)])
}
# Directory where your CpG report files are stored
data_dir <- "/home/projects/cu_10031/data/raw/DNBC_methylation_2023/2025_analysis/child_dataset/"
# Filenames are missing .gz
sample_info$file_name <- paste0(sample_info$file_name, ".gz")
# Create a DataFrame for colData (should at least include sample_id)
col_data <- DataFrame(sample_id = sample_info$sample_id)
# Read Bismark data into bsseq object
#bsseq_obj <- bsseq::read.bismark(
#  files = file.path(data_dir, sample_info$file_name),
# colData = col_data,
#  rmZeroCov = TRUE,
#  strandCollapse = TRUE
#)
library(BiocParallel)
# Force sequential backend
bp <- SerialParam()
bsseq_obj <- bsseq::read.bismark(
files = file.path(data_dir, sample_info$file_name),
colData = col_data,
rmZeroCov = TRUE,
strandCollapse = TRUE,
BPPARAM = bp
)
View(covars)
# Save for later use
save(bsseq_obj, file = "bsseq_child_data.rda")
knitr::opts_chunk$set(echo = TRUE)
library(bsseq)
knitr::opts_chunk$set(echo = TRUE)
library(bsseq)
getwd()
setwd("/home/projects/cu_10031/data/raw/DNBC_methylation_2023/2025_analysis/methylkit_analysis/")
# Setup
library(methylKit)
# Set the output directory
output_dir <- "results/dml_no_covars"
# Load the prepped data
load("results/data_prepped.RData")
load("results/dml_no_covars_results.Rdata")
load("results/dml_no_covars_results.RData")
load("results/data_prepped.RData")
DMR_list_25 <- getMethylDiff(
myDiff_DMR,
qvalue = 0.01,
difference = 25,
type = "all" )
# Convert sigDMLs to GRanges
DMR_GRanges_25 <- as(DMR_list_25, "GRanges")
# Subset meth.min to significant CpGs only
DMR_counts_25 <- regionCounts(meth.min, DMR_GRanges_25)
# Now get methylation percentages
DMR_meth_perc_25  <- percMethylation(DMR_counts_25)
sample_IDs <- getSampleID(DMR_counts_25)
